{"version":3,"file":"main.js","mappings":"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","sources":["webpack:///./src/endpoints/Hierarchy/Hierarchy.ts","webpack:///./src/endpoints/Hierarchy/index.ts","webpack:///./src/endpoints/index.ts","webpack:///./src/services/common/index.ts","webpack:///./src/services/common/mongodb/index.ts","webpack:///./src/services/common/mongodb/mongodb.ts","webpack:///./src/services/hierarchy/hierarchy.ts","webpack:///./src/services/hierarchy/index.ts","webpack:///../../libs/server/src/decorators/Endpoint/Endpoint.ts","webpack:///../../libs/server/src/decorators/Endpoint/index.ts","webpack:///../../libs/server/src/decorators/Module/Modules.ts","webpack:///../../libs/server/src/decorators/Module/index.ts","webpack:///../../libs/server/src/decorators/index.ts","webpack:///../../libs/server/src/index.ts","webpack:///../../libs/server/src/types/index.ts","webpack:///external commonjs \"cookie-parser\"","webpack:///external commonjs \"express\"","webpack:///external commonjs \"jsonwebtoken\"","webpack:///external commonjs \"mongodb\"","webpack:///external commonjs \"tslib\"","webpack:///webpack/bootstrap","webpack:///./src/main.ts"],"sourcesContent":["import jwt from 'jsonwebtoken';\nimport { Module, Endpoint } from '@appcraft/server';\nimport { Request, Response } from 'express';\nimport type { Userinfo } from '@appcraft/server';\n\nimport * as hierarchy from '~data-forge/services/hierarchy';\nimport type * as HierarchyTypes from '~data-forge/services/hierarchy';\n\n@Module({ base: 'hierarchy' })\nexport default class Hierarchy {\n  @Endpoint({\n    url: 'search/:category',\n    method: 'post',\n    description: '查詢 Hierarchy Data',\n  })\n  async search(req: Request, res: Response) {\n    const { id } = jwt.verify(\n      req.cookies.jwt,\n      __WEBPACK_DEFINE__.JWT_SECRET\n    ) as Userinfo;\n\n    res.json(\n      await hierarchy.search(\n        id,\n        req.params.category,\n        req.body as HierarchyTypes.SearchParams\n      )\n    );\n  }\n\n  @Endpoint({\n    method: 'post',\n    description: '建立新的 Hierarchy Group / Item',\n  })\n  async add(req: Request, res: Response) {\n    const { id } = jwt.verify(\n      req.cookies.jwt,\n      __WEBPACK_DEFINE__.JWT_SECRET\n    ) as Userinfo;\n\n    res.json(await hierarchy.add(id, req.body as HierarchyTypes.HierarchyData));\n  }\n}\n","export { default as Hierarchy } from './Hierarchy';\n","export * from './Hierarchy';\n","export * from './mongodb';\n","export * from './mongodb';\n","import { MongoClient, ServerApiVersion } from 'mongodb';\nimport type * as Types from './mongodb.types';\n\nconst clientSync = new MongoClient(__WEBPACK_DEFINE__.MONGODB_CONNECTION, {\n  serverApi: ServerApiVersion.v1,\n}).connect();\n\nexport const getClient: Types.GetClient = () => clientSync;\n\nexport const getCollection: Types.GetCollection = async <T>({\n  db,\n  collection,\n}) => {\n  const client = await getClient();\n\n  return client.db(db).collection<T>(collection);\n};\n","import { ObjectId } from 'mongodb';\n\nimport { getCollection } from '../common';\nimport type * as Types from './hierarchy.types';\n\nexport const search: Types.SearchService = async (\n  userid,\n  category,\n  { keyword, superior }\n) => {\n  const collection = await getCollection<Types.HierarchyData<ObjectId>>({\n    db: 'data-forge',\n    collection: 'hierarchy',\n  });\n\n  const cursor = await collection.find({\n    userid: { $eq: userid },\n    category: { $eq: category },\n    ...(superior && {\n      superior: { $eq: superior },\n    }),\n    ...(keyword && {\n      $or: [\n        { name: { $regex: keyword, $options: 'i' } },\n        { description: { $regex: keyword, $options: 'i' } },\n      ],\n    }),\n  });\n\n  return cursor\n    .sort({\n      category: 'asc',\n      name: 'asc',\n    })\n    .toArray();\n};\n\nexport const add: Types.AddService = async (userid, newData) => {\n  const collection = await getCollection<Types.HierarchyData<ObjectId>>({\n    db: 'data-forge',\n    collection: 'hierarchy',\n  });\n\n  const result = await collection.insertOne({\n    ...newData,\n    userid,\n    _id: new ObjectId(),\n  });\n\n  return {\n    ...newData,\n    _id: result.insertedId,\n  };\n};\n","export * from './hierarchy';\nexport type { HierarchyData, SearchParams } from './hierarchy.types';\n","import * as Types from './Endpoint.types';\n\nexport default function Endpoint({\n  url,\n  method = 'get',\n  params,\n}: Types.DecoratorOptions) {\n  return (_target: any, propertyKey: string, descriptor: Types.Descriptor) => {\n    Object.defineProperty(descriptor.value, 'endpoint', {\n      get: () => ({\n        url: url || propertyKey || '',\n        method,\n        params,\n      }),\n    });\n  };\n}\n","export { default as Endpoint } from './Endpoint';\n","import { Express, IRouterMatcher } from 'express';\nimport * as Types from './Module.types';\n\nexport default function Module({ base: baseURL }: Types.DecoratorOptions) {\n  return <T extends Types.DefaultImplement>(Implement: T) =>\n    class Endpoint extends Implement {\n      constructor(...args: any[]) {\n        const app = args[0] as Express;\n\n        super();\n\n        Object.getOwnPropertyNames(Implement.prototype).forEach((method) => {\n          if (method !== 'constructor') {\n            const {\n              url: endpointURL,\n              method: requestMethod,\n              params = [],\n            } = this[method]?.endpoint;\n\n            const router: IRouterMatcher<any> = app[requestMethod]?.bind(app);\n\n            router(\n              `/${baseURL}/${endpointURL}/${params.join('/')}`,\n              async (req, res) => {\n                try {\n                  await this[method]?.(req, res);\n                } catch (err) {\n                  console.error(`${Implement.name} Exception:`, err);\n\n                  res.status(400).json({\n                    implement: Implement.name,\n                    err: `${err.toString()}`,\n                  });\n                }\n              }\n            );\n          }\n        });\n      }\n    };\n}\n","export { default as Module } from './Modules';\nexport type { DefaultImplement } from './Module.types';\n","export * from './Endpoint';\nexport * from './Module';\n","export * from './decorators';\nexport * from './types';\n","export type { Userinfo } from './Userinfo';\n","module.exports = require(\"cookie-parser\");","module.exports = require(\"express\");","module.exports = require(\"jsonwebtoken\");","module.exports = require(\"mongodb\");","module.exports = require(\"tslib\");","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","import cookieParser from 'cookie-parser';\nimport express from 'express';\nimport type { DefaultImplement } from '@appcraft/server';\n\nimport * as endpoints from './endpoints';\n\nconst port = process.env.SERVICE_DATA_FORGE.replace(/^.+:/, '');\n\nconst app = express()\n  .use(cookieParser())\n  .use(express.json())\n  .use(express.urlencoded({ extended: true }));\n\nObject.values(endpoints).forEach(\n  (EndPoint: DefaultImplement) => new EndPoint(app)\n);\n\napp\n  .get('/', (_req, res) =>\n    res\n      .setHeader('Content-type', 'text/html')\n      .send(\n        `<h1>@appcraft/data-forge:${port}<br/>v${__WEBPACK_DEFINE__.VERSION}</h1>`\n      )\n  )\n  .listen(port)\n  .on('error', console.error)\n  .on('listening', () => console.log(`Listening at ${port}`));\n"],"names":[],"sourceRoot":""}