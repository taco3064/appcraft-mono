{"version":3,"file":"main.js","mappings":"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","sources":["webpack:///./src/endpoints/OAuth2/OAuth2.ts","webpack:///./src/endpoints/OAuth2/index.ts","webpack:///./src/endpoints/Userinfo/Userinfo.ts","webpack:///./src/endpoints/Userinfo/index.ts","webpack:///./src/endpoints/index.ts","webpack:///./src/services/google-oauth2/google-oauth2.ts","webpack:///./src/services/google-oauth2/index.ts","webpack:///../../libs/server/src/decorators/Endpoint/Endpoint.ts","webpack:///../../libs/server/src/decorators/Endpoint/index.ts","webpack:///../../libs/server/src/decorators/Module/Modules.ts","webpack:///../../libs/server/src/decorators/Module/index.ts","webpack:///../../libs/server/src/decorators/index.ts","webpack:///../../libs/server/src/index.ts","webpack:///../../libs/server/src/types/index.ts","webpack:///external commonjs \"cookie-parser\"","webpack:///external commonjs \"express\"","webpack:///external commonjs \"google-auth-library\"","webpack:///external commonjs \"http-proxy-middleware\"","webpack:///external commonjs \"jsonwebtoken\"","webpack:///external commonjs \"tslib\"","webpack:///external node-commonjs \"path\"","webpack:///webpack/bootstrap","webpack:///./src/main.ts"],"sourcesContent":["import jwt from 'jsonwebtoken';\nimport { Module, Endpoint } from '@appcraft/server';\nimport { Request, Response } from 'express';\n\nimport * as googleOauth2 from '~proxy/services/google-oauth2';\n\n@Module({ base: 'oauth2' })\nexport default class OAuth2 {\n  @Endpoint({\n    method: 'get',\n    description: '跳轉至 Google 登入畫面',\n  })\n  async google(_req: Request, res: Response) {\n    res.redirect(await googleOauth2.getAuthURL());\n  }\n\n  @Endpoint({\n    url: 'google/callback',\n    method: 'get',\n    description: '初始化登入',\n  })\n  async callback4Google(req: Request, res: Response) {\n    const { code } = req.query as { code: string };\n    const credentials = await googleOauth2.initialCredentials(code);\n    const cookieOpts = { expires: new Date(credentials.expiry_date) };\n\n    res\n      .cookie(\n        'id',\n        jwt.sign(credentials.id_token, __WEBPACK_DEFINE__.JWT_SECRET),\n        cookieOpts\n      )\n      .cookie(\n        'access',\n        jwt.sign(credentials.access_token, __WEBPACK_DEFINE__.JWT_SECRET),\n        cookieOpts\n      )\n      .redirect('/');\n  }\n\n  @Endpoint({\n    method: 'get',\n    description: '登出',\n  })\n  async signout(req: Request, res: Response) {\n    const accessToken = jwt.verify(\n      req.query.access as string,\n      __WEBPACK_DEFINE__.JWT_SECRET\n    ) as string;\n\n    //! 目前只有使用 Google OAuth2, 若未來支援其他登入方式, 此處必須調整\n    await googleOauth2.revokeToken(accessToken);\n\n    res.clearCookie('access').clearCookie('id').redirect('/');\n  }\n}\n","export { default as OAuth2 } from './OAuth2';\n","import jwt from 'jsonwebtoken';\nimport { Module, Endpoint } from '@appcraft/server';\nimport { Request, Response } from 'express';\n\nimport * as googleOauth2 from '~proxy/services/google-oauth2';\n\n@Module({ base: 'userinfo' })\nexport default class Userinfo {\n  @Endpoint({\n    method: 'get',\n    description: '取得使用者資訊',\n  })\n  async profile(req: Request, res: Response) {\n    const idToken = jwt.verify(\n      req.cookies.id,\n      __WEBPACK_DEFINE__.JWT_SECRET\n    ) as string;\n\n    //! 目前只有使用 Google OAuth2, 若未來支援其他登入方式, 此處必須調整\n    res.json(await googleOauth2.verifyToken(idToken));\n  }\n}\n","export { default as Userinfo } from './Userinfo';\n","export * from './OAuth2';\nexport * from './Userinfo';\n","import { OAuth2Client } from 'google-auth-library';\nimport type * as Types from './google-oauth2.types';\n\nconst client = new OAuth2Client(\n  __WEBPACK_DEFINE__.GOOGLE_CLIENT_ID,\n  __WEBPACK_DEFINE__.GOOGLE_CLIENT_SECRET,\n  process.env.GOOGLE_REDIRECT_URI\n);\n\nexport const getAuthURL: Types.GetAuthURLService = async () => {\n  return client.generateAuthUrl({\n    access_type: 'offline',\n    scope: ['profile', 'email'],\n  });\n};\n\nexport const initialCredentials: Types.InitialCredentialsService = async (\n  code\n) => {\n  const { tokens } = await client.getToken(code);\n\n  client.setCredentials(tokens);\n\n  return tokens;\n};\n\nexport const revokeToken: Types.RevokeTokenService = async (accessToken) => {\n  await client.revokeToken(accessToken);\n};\n\nexport const verifyToken: Types.VerifyTokenService = async (idToken) => {\n  const ticket = await client.verifyIdToken({\n    idToken,\n    audience: process.env.GOOGLE_CLIENT_ID,\n  });\n\n  const payload = ticket.getPayload();\n\n  return {\n    id: payload.sub,\n    username: payload.name,\n    email: payload.email,\n    picture: payload.picture,\n    expires: payload.exp,\n  };\n};\n","export * from './google-oauth2';\n","import * as Types from './Endpoint.types';\n\nexport default function Endpoint({\n  url,\n  method = 'get',\n  params,\n}: Types.DecoratorOptions) {\n  return (\n    _target: unknown,\n    propertyKey: string,\n    descriptor: Types.Descriptor\n  ) => {\n    Object.defineProperty(descriptor.value, 'endpoint', {\n      get: () => ({\n        url: url || propertyKey || '',\n        method,\n        params,\n      }),\n    });\n  };\n}\n","export { default as Endpoint } from './Endpoint';\n","import { Express, IRouterMatcher } from 'express';\nimport * as Types from './Module.types';\n\nexport default function Module({ base: baseURL }: Types.DecoratorOptions) {\n  return <T extends Types.DefaultImplement>(Implement: T) =>\n    class Endpoint extends Implement {\n      constructor(...args: any[]) {\n        const app = args[0] as Express;\n\n        super();\n\n        Object.getOwnPropertyNames(Implement.prototype).forEach((method) => {\n          if (method !== 'constructor') {\n            const {\n              url: endpointURL,\n              method: requestMethod,\n              params = [],\n            } = this[method]?.endpoint || {};\n\n            const router: IRouterMatcher<any> = app[requestMethod]?.bind(app);\n\n            router(\n              `/${baseURL}/${endpointURL}/${params.join('/')}`,\n              async (req, res) => {\n                try {\n                  await this[method]?.(req, res);\n                } catch (err) {\n                  console.error(`${Implement.name} Exception:`, err);\n\n                  res.status(400).json({\n                    implement: Implement.name,\n                    err: `${err.toString()}`,\n                  });\n                }\n              }\n            );\n          }\n        });\n      }\n    };\n}\n","export { default as Module } from './Modules';\nexport type { DefaultImplement } from './Module.types';\n","export * from './Endpoint';\nexport * from './Module';\n","export * from './decorators';\nexport * from './types';\n","export type { Userinfo } from './Userinfo';\n","module.exports = require(\"cookie-parser\");","module.exports = require(\"express\");","module.exports = require(\"google-auth-library\");","module.exports = require(\"http-proxy-middleware\");","module.exports = require(\"jsonwebtoken\");","module.exports = require(\"tslib\");","module.exports = require(\"path\");","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","import cookieParser from 'cookie-parser';\nimport express from 'express';\nimport jwt from 'jsonwebtoken';\nimport path from 'path';\nimport { createProxyMiddleware, fixRequestBody } from 'http-proxy-middleware';\nimport type { DefaultImplement } from '@appcraft/server';\n\nimport { verifyToken } from '~proxy/services/google-oauth2';\nimport * as endpoints from './endpoints';\n\nconst port = process.env.SERVICE_PROXY.replace(/^.+:/, '');\n\nconst app = express()\n  .use(cookieParser())\n  .use(express.json())\n  .use(express.urlencoded({ extended: true }))\n  .use('/assets', express.static(path.join(__dirname, 'assets')))\n  .use(async (req, res, next) => {\n    if (!/^\\/oauth2\\//.test(req.url) && '/' !== req.url) {\n      try {\n        const idToken = jwt.verify(\n          req.cookies.id,\n          __WEBPACK_DEFINE__.JWT_SECRET\n        ) as string;\n\n        const { expires: expiresIn, ...user } = await verifyToken(idToken);\n        const expires = new Date(new Date().valueOf() + expiresIn);\n\n        res.cookie(\n          'jwt',\n          jwt.sign(user, __WEBPACK_DEFINE__.JWT_SECRET, { expiresIn }),\n          {\n            expires,\n            httpOnly: true,\n          }\n        );\n      } catch (e) {\n        console.error(e);\n        return res.status(401).json({ error: 'Unauthorized' });\n      }\n    }\n\n    next();\n  })\n  .use(\n    '/data-forge',\n    createProxyMiddleware({\n      target: process.env.SERVICE_DATA_FORGE,\n      changeOrigin: true,\n      onProxyReq: fixRequestBody,\n      pathRewrite: {\n        '^/data-forge': '',\n      },\n    })\n  )\n  .use(\n    '/ts2-props',\n    createProxyMiddleware({\n      target: process.env.SERVICE_TS2_PROPS,\n      changeOrigin: true,\n      onProxyReq: fixRequestBody,\n      pathRewrite: {\n        '^/ts2-props': '',\n      },\n    })\n  );\n\nObject.values(endpoints).forEach(\n  (EndPoint: DefaultImplement) => new EndPoint(app)\n);\n\napp\n  .get('/', (_req, res) =>\n    res\n      .setHeader('Content-type', 'text/html')\n      .send(\n        `<h1>@appcraft/proxy:${port}<br/>v${__WEBPACK_DEFINE__.VERSION}</h1>`\n      )\n  )\n  .listen(port)\n  .on('error', console.error)\n  .on('listening', () => console.log(`Listening at ${port}`));\n"],"names":[],"sourceRoot":""}